name: ğŸ“ˆ æ¯æ—¥è‚¡å¸‚åˆ†æ

on:
  # æ’ç¨‹åŸ·è¡Œ
  schedule:
    # å°è‚¡ï¼šé€±ä¸€è‡³é€±äº” 14:30 å°ç£æ™‚é–“ (06:30 UTC)
    - cron: '30 6 * * 1-5'
    # ç¾è‚¡ï¼šé€±äºŒè‡³é€±å…­ 05:30 å°ç£æ™‚é–“ (21:30 UTC å‰ä¸€å¤©)
    - cron: '30 21 * * 1-5'

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      market:
        description: 'åˆ†æå¸‚å ´'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install -r requirements.txt

      - name: ğŸ“ å»ºç«‹è¨­å®šæª”
        run: |
          cp config/settings.example.py config/settings.py
          python -c "
          import pathlib, re
          p = pathlib.Path('config/settings.py')
          text = p.read_text()
          text = re.sub(
              r'DISCORD_WEBHOOK_URL\s*=\s*.*',
              'import os\nDISCORD_WEBHOOK_URL = os.environ.get(\"DISCORD_WEBHOOK_URL\", \"\")',
              text,
              count=1,
          )
          p.write_text(text)
          "

      - name: ğŸ” åˆ¤æ–·åˆ†æå¸‚å ´
        id: market
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "market=${{ github.event.inputs.market }}" >> $GITHUB_OUTPUT
          else
            # æ ¹æ“š UTC æ™‚é–“åˆ¤æ–·
            HOUR=$(date -u +%H)
            if [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 12 ]; then
              echo "market=tw" >> $GITHUB_OUTPUT
            else
              echo "market=us" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ“Š åŸ·è¡Œè‚¡å¸‚åˆ†æ
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python main.py --market ${{ steps.market.outputs.market }}

      - name: âœ… å®Œæˆ
        run: echo "åˆ†æå®Œæˆï¼å·²æ¨æ’­åˆ° Discord"
