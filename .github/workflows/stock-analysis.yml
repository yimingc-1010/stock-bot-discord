name: ğŸ“ˆ æ¯æ—¥è‚¡å¸‚åˆ†æ

on:
  # æ’ç¨‹åŸ·è¡Œ
  schedule:
    # å°è‚¡ï¼šé€±ä¸€è‡³é€±äº” 14:30 å°ç£æ™‚é–“ (06:30 UTC)
    - cron: '30 6 * * 1-5'
    # ç¾è‚¡ï¼šé€±äºŒè‡³é€±å…­ 05:30 å°ç£æ™‚é–“ (21:30 UTC å‰ä¸€å¤©)
    - cron: '30 21 * * 1-5'

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      market:
        description: 'åˆ†æå¸‚å ´'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ è¨­å®š Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: pip install -r requirements.txt

      - name: ğŸ“ å»ºç«‹è¨­å®šæª”
        run: |
          cat > config/settings.py << 'EOF'
          """è‚¡ç¥¨æ¨æ’­æ©Ÿå™¨äººé…ç½®æª”æ¡ˆ"""

          import os

          DISCORD_WEBHOOK_URL = os.environ.get('DISCORD_WEBHOOK_URL', '')

          MARKETS = {
              "TW": {
                  "name": "å°è‚¡",
                  "index_symbol": "^TWII",
                  "sectors": {
                      "åŠå°é«”": ["2330.TW", "2454.TW", "2303.TW", "3711.TW", "2379.TW"],
                      "é›»å­é›¶çµ„ä»¶": ["2317.TW", "2382.TW", "3008.TW", "2408.TW", "2327.TW"],
                      "é‡‘è": ["2881.TW", "2882.TW", "2883.TW", "2884.TW", "2891.TW"],
                      "å‚³ç”¢": ["1301.TW", "1303.TW", "1326.TW", "2002.TW", "2105.TW"],
                      "èˆªé‹": ["2603.TW", "2609.TW", "2615.TW", "2618.TW", "5880.TW"],
                      "ç”ŸæŠ€é†«ç™‚": ["4904.TW", "1476.TW", "6446.TW", "4743.TW", "1707.TW"],
                      "ç¶ èƒ½": ["3481.TW", "6803.TW", "3576.TW", "6443.TW", "6488.TW"],
                  }
              },
              "US": {
                  "name": "ç¾è‚¡",
                  "indices": {
                      "S&P 500": "^GSPC",
                      "é“ç“Šå·¥æ¥­": "^DJI",
                      "é‚£æ–¯é”å…‹": "^IXIC",
                      "è²»åŸåŠå°é«”": "^SOX",
                  },
                  "sectors": {
                      "ç§‘æŠ€å·¨é ­": ["AAPL", "MSFT", "GOOGL", "AMZN", "META", "NVDA"],
                      "åŠå°é«”": ["NVDA", "AMD", "INTC", "TSM", "AVGO", "QCOM"],
                      "AIæ¦‚å¿µ": ["NVDA", "MSFT", "GOOGL", "PLTR", "AI", "SNOW"],
                      "é›»å‹•è»Š": ["TSLA", "RIVN", "LCID", "NIO", "LI", "XPEV"],
                      "é‡‘è": ["JPM", "BAC", "WFC", "GS", "MS", "C"],
                      "é†«ç™‚ä¿å¥": ["JNJ", "UNH", "PFE", "ABBV", "MRK", "LLY"],
                      "èƒ½æº": ["XOM", "CVX", "COP", "SLB", "EOG", "PXD"],
                  }
              }
          }

          TECHNICAL_PARAMS = {
              "sma_short": 5,
              "sma_medium": 20,
              "sma_long": 60,
              "rsi_period": 14,
              "rsi_overbought": 70,
              "rsi_oversold": 30,
              "macd_fast": 12,
              "macd_slow": 26,
              "macd_signal": 9,
              "volume_ma": 20,
          }

          FILTER_PARAMS = {
              "min_volume_ratio": 1.5,
              "min_price_change": 2.0,
              "max_price_change": 10.0,
              "rsi_min": 40,
              "rsi_max": 75,
          }

          SCHEDULE = {
              "tw_market_close": "14:30",
              "us_market_close": "05:30",
              "timezone": "Asia/Taipei"
          }
          EOF

      - name: ğŸ” åˆ¤æ–·åˆ†æå¸‚å ´
        id: market
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "market=${{ github.event.inputs.market }}" >> $GITHUB_OUTPUT
          else
            # æ ¹æ“š UTC æ™‚é–“åˆ¤æ–·
            HOUR=$(date -u +%H)
            if [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 12 ]; then
              echo "market=tw" >> $GITHUB_OUTPUT
            else
              echo "market=us" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ“Š åŸ·è¡Œè‚¡å¸‚åˆ†æ
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python main.py --market ${{ steps.market.outputs.market }}

      - name: âœ… å®Œæˆ
        run: echo "åˆ†æå®Œæˆï¼å·²æ¨æ’­åˆ° Discord"
